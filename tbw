#!/usr/bin/env bash
set -euo pipefail

VERSION="5.1.0"

# -----------------------
# Defaults
# -----------------------
MODE="tb"    # tb | bytes
VERBOSE=0

usage() {
cat <<EOF
tbw - Extract total bytes written (TBW) from SSDs

Usage:
  tbw [options] <device> [device...]

Options:
  --bytes       Output raw bytes written instead of TB
  -v            Verbose output (device info, bytes, TB)
  -h, --help    Show this help
  -V            Show version

Examples:
  sudo tbw sda
  sudo tbw --bytes /dev/nvme0n1
EOF
}

die() { echo "Error: $*" >&2; exit 1; }
require_cmd() { command -v "$1" >/dev/null || die "$1 not found."; }

normalize() {
    [[ "$1" == /dev/* ]] && echo "$1" || echo "/dev/$1"
}

get_json() {
    smartctl -a -j "$1" 2>/dev/null
}

extract_bytes() {
jq -r '
    def nvme:
        .nvme_smart_health_information_log.data_units_written?
        | select(. != null)
        | . * 512000;

    def sata:
        . as $r
        | (
            $r.ata_smart_attributes.table[]?
            | select(.name == "Total_LBAs_Written" or .id == 241)
            | .raw.value
          ) as $l
        | select($l != null and $r.logical_block_size != null)
        | $l * $r.logical_block_size;

    if .device.protocol == "NVMe" then nvme else sata end
' <<< "$1"
}

# -----------------------
# Options
# -----------------------
while [[ $# -gt 0 ]]; do
    case "$1" in
        --bytes) MODE="bytes" ;;
        -v) VERBOSE=1 ;;
        -h|--help) usage; exit 0 ;;
        -V) echo "tbw $VERSION"; exit 0 ;;
        -*) die "Unknown option: $1" ;;
        *) break ;;
    esac
    shift
done

[[ $# -ge 1 ]] || { usage >&2; exit 1; }

require_cmd smartctl
require_cmd jq

EXIT=0

# -----------------------
# Process devices
# -----------------------
for dev in "$@"; do
    DEV=$(normalize "$dev")
    if [[ ! -e "$DEV" ]]; then
        echo "Device not found: $DEV" >&2
        EXIT=1
        continue
    fi

    if ! JSON=$(get_json "$DEV"); then
        RC=$?
        if (( RC & 2 )); then
            echo "Permission denied: $DEV (try sudo)" >&2
        else
            echo "SMART read failed: $DEV" >&2
        fi
        EXIT=2
        continue
    fi

    if [[ -z "$JSON" ]]; then
        echo "SMART read failed: $DEV" >&2
        EXIT=2
        continue
    fi

    BYTES=$(extract_bytes "$JSON")
    if [[ -z "$BYTES" || "$BYTES" == "null" ]]; then
        echo "TBW not available: $DEV" >&2
        EXIT=3
        continue
    fi

    TB=$(jq -n --argjson b "$BYTES" '($b / 1e12 * 100 | round)/100')

    if [[ $VERBOSE -eq 1 ]]; then
        PROTO=$(jq -r '.device.protocol' <<< "$JSON")
        echo "Drive: $DEV"
        echo "Type: $PROTO"
        echo "Bytes written: $BYTES"
        echo "Terabytes written: $TB TB"
    else
        if [[ "$MODE" == "bytes" ]]; then
            echo "$BYTES"
        else
            echo "$TB"
        fi
    fi
done

exit "$EXIT"