#!/usr/bin/env bash
set -euo pipefail

VERSION="2.0.0"
VERBOSE=0

usage() {
cat <<EOF
tbw - Calculate SSD Terabytes Written (TBW) from SMART data

Usage:
  tbw [options] <device>

Options:
  -v            Verbose output
  -h, --help    Show this help
  -V, --version Show version

Examples:
  sudo tbw sda
  sudo tbw /dev/nvme0n1
  sudo tbw -v sda
EOF
}

die() {
    echo "Error: $*" >&2
    exit 1
}

require_root() {
    [[ $EUID -eq 0 ]] || die "Run as root (sudo)."
}

require_smartctl() {
    command -v smartctl >/dev/null 2>&1 || \
        die "smartctl not found. Install smartmontools."
}

normalize_device() {
    local input="$1"
    [[ "$input" == /dev/* ]] && echo "$input" || echo "/dev/$input"
}

get_smart_output() {
    smartctl -a "$1" 2>&1 || true
}

detect_type() {
    if grep -qi "NVMe" <<< "$1"; then
        echo "NVMe"
    else
        echo "SATA"
    fi
}

parse_nvme_bytes() {
    local smart="$1"

    local units
    units=$(awk '
        /Data Units Written/ {
            # Everything after the colon
            sub(/.*:/, "", $0)

            # Remove bracket part
            sub(/\[.*/, "", $0)

            # Remove all spaces
            gsub(/[[:space:]]/, "", $0)

            print
            exit
        }
    ' <<< "$smart")

    [[ "$units" =~ ^[0-9]+$ ]] || \
        die "Could not parse NVMe Data Units Written"

    awk -v u="$units" 'BEGIN {printf "%.0f\n", u * 512000}'
}

parse_sata_bytes() {
    local smart="$1"

    local sector_size
    sector_size=$(awk '/Sector Size/ {
        for (i=1;i<=NF;i++)
            if ($i ~ /^[0-9]+$/) { print $i; exit }
    }' <<< "$smart")

    local lbas
    lbas=$(awk '/Total_LBAs_Written/ {print $NF; exit}' <<< "$smart")

    [[ -n "$sector_size" ]] || die "Could not determine sector size"
    [[ -n "$lbas" ]] || die "Could not determine Total_LBAs_Written"

    echo $(( lbas * sector_size ))
}

bytes_to_tb() {
    awk -v bytes="$1" 'BEGIN {printf "%.2f", bytes/1000000000000}'
}

# -----------------------
# Option handling
# -----------------------

case "${1:-}" in
    --help) usage; exit 0 ;;
    --version) echo "tbw $VERSION"; exit 0 ;;
esac

while getopts "vhV" opt; do
    case "$opt" in
        v) VERBOSE=1 ;;
        h) usage; exit 0 ;;
        V) echo "tbw $VERSION"; exit 0 ;;
        *) usage >&2; exit 1 ;;
    esac
done
shift $((OPTIND - 1))

[[ -n "${1:-}" ]] || { usage >&2; exit 1; }

# -----------------------
# Validation
# -----------------------

require_root
require_smartctl

DEVICE=$(normalize_device "$1")
[[ -e "$DEVICE" ]] || die "Device not found: $DEVICE"

SMART=$(get_smart_output "$DEVICE")
TYPE=$(detect_type "$SMART")

if [[ "$TYPE" == "NVMe" ]]; then
    BYTES=$(parse_nvme_bytes "$SMART")
else
    BYTES=$(parse_sata_bytes "$SMART")
fi

TB=$(bytes_to_tb "$BYTES")

# -----------------------
# Output
# -----------------------

if [[ $VERBOSE -eq 1 ]]; then
    echo "Drive: $DEVICE"
    echo "Type: $TYPE"
    echo "Bytes written: $BYTES"
    echo "Terabytes written: $TB TB"
else
    echo "$TB"
fi