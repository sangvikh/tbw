#!/usr/bin/env bash
set -euo pipefail

VERSION="3.0.0"
VERBOSE=0

usage() {
cat <<EOF
tbw - Calculate SSD Terabytes Written (TBW) from SMART data

Usage:
  tbw [options] <device>

Options:
  -v            Verbose output
  -h, --help    Show this help
  -V, --version Show version

Examples:
  sudo tbw sda
  sudo tbw /dev/nvme0n1
  sudo tbw -v sda
EOF
}

die() {
    echo "Error: $*" >&2
    exit 1
}

require_root() {
    [[ $EUID -eq 0 ]] || die "Run as root (sudo)."
}

require_command() {
    command -v "$1" >/dev/null 2>&1 || \
        die "$1 not found. Please install it."
}

normalize_device() {
    local input="$1"
    [[ "$input" == /dev/* ]] && echo "$input" || echo "/dev/$input"
}

get_smart_json() {
    smartctl -a -j "$1" 2>/dev/null || \
        die "Failed to read SMART data from $1"
}

calculate_tb() {
    jq -r '
    def nvme_tb:
        if .nvme_smart_health_information_log.data_units_written? then
            (.nvme_smart_health_information_log.data_units_written * 512000) / 1e12
        else
            empty
        end;

    def sata_tb:
        (
            .ata_smart_attributes.table[]?
            | select(.name == "Total_LBAs_Written")
            | .raw.value
        ) as $lbas
        | if $lbas and .logical_block_size? then
            ($lbas * .logical_block_size) / 1e12
          else
            empty
          end;

    if .device.protocol == "NVMe" then
        nvme_tb
    else
        sata_tb
    end
    | select(. != null)
    | sprintf("%.2f"; .)
    ' <<< "$1"
}

get_bytes_written() {
    jq -r '
    if .device.protocol == "NVMe" then
        .nvme_smart_health_information_log.data_units_written?
        | select(. != null)
        | . * 512000
    else
        (
            .ata_smart_attributes.table[]?
            | select(.name == "Total_LBAs_Written")
            | .raw.value
        ) as $lbas
        | select($lbas != null and .logical_block_size != null)
        | $lbas * .logical_block_size
    end
    ' <<< "$1"
}

get_type() {
    jq -r '.device.protocol' <<< "$1"
}

# -----------------------
# Option handling
# -----------------------

case "${1:-}" in
    --help) usage; exit 0 ;;
    --version) echo "tbw $VERSION"; exit 0 ;;
esac

while getopts "vhV" opt; do
    case "$opt" in
        v) VERBOSE=1 ;;
        h) usage; exit 0 ;;
        V) echo "tbw $VERSION"; exit 0 ;;
        *) usage >&2; exit 1 ;;
    esac
done
shift $((OPTIND - 1))

[[ -n "${1:-}" ]] || { usage >&2; exit 1; }

# -----------------------
# Validation
# -----------------------

require_root
require_command smartctl
require_command jq

DEVICE=$(normalize_device "$1")
[[ -e "$DEVICE" ]] || die "Device not found: $DEVICE"

SMART_JSON=$(get_smart_json "$DEVICE")

TB=$(calculate_tb "$SMART_JSON") || true
[[ -n "$TB" ]] || die "Could not determine TBW for $DEVICE"

# -----------------------
# Output
# -----------------------

if [[ $VERBOSE -eq 1 ]]; then
    TYPE=$(get_type "$SMART_JSON")
    BYTES=$(get_bytes_written "$SMART_JSON")

    echo "Drive: $DEVICE"
    echo "Type: $TYPE"
    echo "Bytes written: $BYTES"
    echo "Terabytes written: $TB TB"
else
    echo "$TB"
fi